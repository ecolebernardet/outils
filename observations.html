<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Observations - Gestion Classe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #000; color: #eee; padding: 10px; margin: 0; }
        
        .level-column { background: rgba(24, 24, 27, 0.6); border: none; border-radius: 1.5rem; padding: 12px; height: fit-content; }

        .bg-m { background: #dbeafe; color: #1e3a8a; } 
        .bg-f { background: #fce7f3; color: #831843; } 
        
        .student-item { 
            padding: 10px 12px; border-radius: 1rem; 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; transition: all 0.2s; border: 2px solid transparent;
            margin-bottom: 6px;
        }
        .student-item:active { transform: scale(0.96); }
        .has-comment { background: #fff !important; color: #000 !important; border-color: #f472b6; box-shadow: 0 4px 12px rgba(244, 114, 182, 0.3); }

        .student-name { font-weight: 700; font-size: 0.65rem; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 20px; border-radius: 2rem; width: 90%; max-width: 350px; color: #111; }
        textarea { width: 100%; margin: 15px 0; padding: 12px; border-radius: 1rem; border: 1px solid #ddd; font-size: 0.9rem; resize: none; background: #f9f9f9; color: #000; outline: none; }
        
        .modal-btn { flex: 1; padding: 14px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 10px; text-transform: uppercase; }
        .btn-save { background: #ff5a98; color: white; }
        .btn-cancel { background: #eee; color: #555; }

        .btn-nav { font-weight: 800; padding: 14px; border-radius: 50px; font-size: 10px; text-align: center; text-transform: uppercase; display: block; width: 100%; border:none; cursor: pointer; }
    </style>
</head>
<body>

    <div class="max-w-4xl mx-auto">
        <h1 class="text-center text-xl font-black uppercase my-2 tracking-tighter">Observations</h1>

        <div id="listeContainer"></div>

        <div class="max-w-md mx-auto mt-6 mb-20">
            <button onclick="window.location.href='index.html'" class="btn-nav bg-[#71bd7b] text-green-950 font-black">Retour Accueil</button>
        </div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" class="font-black uppercase text-sm border-b pb-2 text-zinc-800">Ã‰lÃ¨ve</h2>
            <textarea id="commentInput" rows="8" placeholder="Notez ici..."></textarea>
            <div class="flex gap-3">
                <button class="modal-btn btn-cancel" onclick="closeModal()">Annuler</button>
                <button class="modal-btn btn-save" onclick="saveData()">Valider</button>
            </div>
        </div>
    </div>

    <script>
        let currentId = null;

        function formaterAffichage(texte) {
            const parts = texte.trim().split(" ");
            if (parts.length === 0) return "";
            const prenom = parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase();
            const nom = parts.slice(1).join(" ").toUpperCase();
            return prenom + " " + nom;
        }

        function renderList() {
            const container = document.getElementById('listeContainer');
            const eleves = JSON.parse(localStorage.getItem('maListeEleves')) || [];
            const savedComments = JSON.parse(localStorage.getItem('studentObservations')) || {};
            
            container.innerHTML = "";

            if (eleves.length === 0) {
                container.innerHTML = `<div class="max-w-md mx-auto text-center p-10 border-2 border-dashed border-zinc-800 rounded-3xl mt-10 text-zinc-500 font-bold text-[10px] uppercase">Aucun Ã©lÃ¨ve trouvÃ©.</div>`;
                return;
            }

            const groupes = {};
            eleves.forEach(el => {
                const niv = el.niveau.toUpperCase();
                if (!groupes[niv]) groupes[niv] = [];
                groupes[niv].push(el);
            });

            const nomsNiveaux = Object.keys(groupes).sort();
            
            if (nomsNiveaux.length === 2) {
                container.className = "grid grid-cols-2 gap-4 items-start";
            } else {
                container.className = "flex flex-col gap-6 max-w-md mx-auto";
            }

            nomsNiveaux.forEach(niv => {
                const col = document.createElement('div');
                col.className = "level-column";
                col.innerHTML = `<h3 class="text-[10px] font-black text-zinc-500 uppercase mb-4 text-center tracking-widest pb-1">${niv} â€” ${groupes[niv].length}</h3>`;
                
                const listEl = document.createElement('div');
                groupes[niv].sort((a,b) => a.identite.localeCompare(b.identite)).forEach(el => {
                    const comment = savedComments[el.id] || "";
                    const identitePropre = formaterAffichage(el.identite);
                    const item = document.createElement('div');
                    
                    item.className = `student-item bg-${el.sexe}` + (comment.trim() ? ' has-comment' : '');
                    item.innerHTML = `
                        <span class="student-name">${identitePropre}</span>
                        <span class="text-xs">${comment.trim() ? 'ðŸ”Ž' : 'âž”'}</span>
                    `;
                    item.onclick = () => openModal(el.id, identitePropre);
                    listEl.appendChild(item);
                });
                col.appendChild(listEl);
                container.appendChild(col);
            });
        }

        function openModal(id, nom) {
            currentId = id;
            const savedComments = JSON.parse(localStorage.getItem('studentObservations')) || {};
            document.getElementById('modalTitle').innerText = nom;
            document.getElementById('commentInput').value = savedComments[id] || "";
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        function saveData() {
            const val = document.getElementById('commentInput').value;
            let savedComments = JSON.parse(localStorage.getItem('studentObservations')) || {};
            if(val.trim() === "") delete savedComments[currentId];
            else savedComments[currentId] = val;
            localStorage.setItem('studentObservations', JSON.stringify(savedComments));
            closeModal();
            renderList();
        }

        renderList();
    </script>
</body>
</html>